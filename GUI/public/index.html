<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />

    <title>OpenStreetMap Routing With Neo4j</title>

    <!-- TODO: add favicon -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="docs/images/favicon.ico"
    />

    <!-- CSS for leaflet and leaflet-geoman plugin -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
      integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css"
    />

    <!-- Load JavaScript for leaflet, leaflet-geoman plugin, turf.js, and neo4j-driver -->
    <script
      src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
      integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>

    <!-- Fixed size map area -->
    <style>
      html,
      body {
        height: 95%;
        margin: 0;
      }
      #btnCreateLine {
        margin-top: 10px;
      }
      #btnShowCentrality {
        margin-top: 10px;
        margin-right: 10px;
      }
      /* .leaflet-container {
        width: 1000px;
        height: 1000px;
      } */
    </style>
  </head>
  <body>
    <!-- Fixed size map area -->
    <div id="map" style="width: 100%; height: 100%"></div>
    <button id="btnCreateLine">Create Line</button>
    <button id="btnShowCentrality">Show Centrality</button>
    <!-- TODO: move this into it's own JavaScript file -->
    <!-- TODO: read credentials from env vars -->
    <script>
      
      const coordinates = [[45.5894436, -122.3311416], [45.5891353, -122.3312076], [45.5890399, -122.3312076], [45.5887913, -122.3311492], [45.5886057, -122.3311314], [45.5883857, -122.3311309], [45.5883857, -122.3311309], [45.5883863, -122.3313097], [45.5883863, -122.3313097], [45.5883878, -122.332306], [45.5883878, -122.332306], [45.5883885, -122.3327426], [45.5883885, -122.3327426], [45.5883886, -122.3328662], [45.5883893, -122.3343798], [45.588392, -122.3353612], [45.5883946, -122.3365879], [45.5883963, -122.3373759], [45.5883963, -122.3373759], [45.5887767, -122.3373763], [45.5891535, -122.3373718], [45.5891535, -122.3373718], [45.5894788, -122.3373698], [45.5896149, -122.337362], [45.5898034, -122.3373352], [45.5898034, -122.3373352], [45.59008, -122.337243], [45.5902546, -122.337172], [45.5905928, -122.3369906], [45.5907504, -122.3368971], [45.5907772, -122.3368819], [45.5910019, -122.3367547], [45.5912137, -122.3366245], [45.5913688, -122.336533], [45.5914029, -122.3365135], [45.5915383, -122.336434], [45.5916839, -122.336355], [45.5918297, -122.3362762], [45.5920851, -122.3361379], [45.5925858, -122.3358593], [45.5925858, -122.3358593], [45.592699, -122.3358001], [45.592699, -122.3358001], [45.5927869, -122.3357597], [45.5931661, -122.3355902], [45.5938946, -122.3353518], [45.5939569, -122.3353327], [45.5948464, -122.3350597], [45.5948464, -122.3350597], [45.5950264, -122.3350016], [45.5951684, -122.3349558], [45.5951684, -122.3349558], [45.5954603, -122.334868], [45.5957397, -122.334756], [45.5959372, -122.334649], [45.5960084, -122.334594], [45.5960663, -122.3345458], [45.5961039, -122.3345203], [45.5962243, -122.3344072], [45.5963265, -122.3342802], [45.5963265, -122.3342802], [45.596536, -122.3339651], [45.5966111, -122.3338153], [45.5966799, -122.3336566], [45.5967565, -122.3334499], [45.5967979, -122.333308], [45.5968368, -122.3331579], [45.5968626, -122.3330351], [45.5968917, -122.3328328], [45.5969203, -122.3323955], [45.5969223, -122.3305397], [45.5969226, -122.3302738], [45.5969226, -122.3302738], [45.596926, -122.3295126], [45.5969283, -122.32901], [45.5969283, -122.32901], [45.596939, -122.3279184], [45.596939, -122.3279184], [45.5969647, -122.3248701], [45.5969647, -122.3248701], [45.5969678, -122.3244766], [45.5970165, -122.3228779], [45.5970165, -122.3228779], [45.5970276, -122.3225881], [45.5970451, -122.3223337], [45.5970736, -122.3220082], [45.5971075, -122.3217268], [45.5971688, -122.3213449], [45.5971741, -122.3213183], [45.5972333, -122.3210214], [45.5972333, -122.3210214], [45.5972952, -122.3207063], [45.5973391, -122.3204916], [45.597364, -122.3203696], [45.5973942, -122.3202404], [45.5975281, -122.3196449], [45.5976382, -122.3191973], [45.5977517, -122.3187401], [45.5978499, -122.3183711], [45.5979219, -122.3181401], [45.5979413, -122.3180786], [45.598089, -122.3176201], [45.5981915, -122.3173456], [45.5982838, -122.3171254], [45.5982945, -122.3171003], [45.5984245, -122.3168804], [45.59853, -122.3167495], [45.5986, -122.3166871], [45.5987196, -122.3166211], [45.5988423, -122.3165938], [45.5989769, -122.3165856], [45.5995362, -122.3165802], [45.5995362, -122.3165802], [45.6003124, -122.3165827], [45.6007553, -122.3165841], [45.6013826, -122.3165861], [45.6018067, -122.3165908], [45.6020148, -122.3165923], [45.6020672, -122.3165872], [45.602126, -122.3165814], [45.6022001, -122.3165696], [45.6022807, -122.3165399], [45.6023568, -122.316493], [45.6024245, -122.316435], [45.6024855, -122.3163619], [45.6025618, -122.3162435], [45.602684, -122.3160364], [45.6030458, -122.3154141], [45.6031916, -122.3151633], [45.6033821, -122.3148233], [45.6034551, -122.3146769], [45.6035038, -122.3145736], [45.6035401, -122.3144729], [45.6035728, -122.3143608], [45.6036011, -122.3141989], [45.6036079, -122.3141405], [45.6036229, -122.3140135], [45.6036425, -122.3137784], [45.6036445, -122.3137582], [45.6036545, -122.3136601], [45.6036785, -122.3134825], [45.6037087, -122.3133062], [45.6037634, -122.3130574], [45.603904, -122.3124875], [45.604057, -122.3119037], [45.6040957, -122.3117867], [45.604135, -122.3116715], [45.6041851, -122.3115765], [45.6042417, -122.3115049], [45.6043223, -122.3114488], [45.6044128, -122.311413], [45.6044847, -122.3113958], [45.6046007, -122.31139], [45.604696, -122.3113865], [45.6051176, -122.3113932], [45.6051737, -122.3113936], [45.6067104, -122.3114047], [45.6069115, -122.3114096], [45.6071348, -122.3113923], [45.6071348, -122.3113923], [45.6071311, -122.3110521], [45.6071258, -122.3100028], [45.6071311, -122.309079], [45.6071325, -122.3069106], [45.6071298, -122.3064921], [45.6071366, -122.3064025], [45.6071597, -122.3063325], [45.6071935, -122.3062876], [45.6071935, -122.3062876], [45.6072309, -122.3062522], [45.6072744, -122.3062347], [45.6073548, -122.3062211], [45.6080449, -122.3062163], [45.6080787, -122.3062161], [45.6089596, -122.3062043], [45.6103181, -122.306186], [45.6106723, -122.3061812], [45.611122, -122.3061752], [45.6113471, -122.306172], [45.612043, -122.3061627], [45.6121714, -122.3061611], [45.6121714, -122.3061611], [45.6141461, -122.3061463], [45.6155467, -122.3061358], [45.6155467, -122.3061358], [45.616033, -122.3061529], [45.6161487, -122.3061393], [45.6162345, -122.3061178], [45.6163189, -122.3060789], [45.6163802, -122.3060108], [45.6164327, -122.3059376], [45.616466, -122.305851], [45.616491, -122.3057373], [45.6165049, -122.3056055], [45.6165085, -122.3054897], [45.6164857, -122.304979], [45.6164409, -122.3042206], [45.6164098, -122.3034877], [45.6164017, -122.3031648], [45.6164039, -122.302953], [45.6164224, -122.3027038], [45.6164439, -122.3024915], [45.616478, -122.3022398], [45.6165227, -122.3019856], [45.6165608, -122.3016605], [45.6165754, -122.301496], [45.6166067, -122.3008245], [45.6166316, -122.3004007], [45.6166599, -122.3001266], [45.6167125, -122.2998003], [45.6167666, -122.299552], [45.6168049, -122.2994005], [45.6168592, -122.299239], [45.6169169, -122.2990973], [45.616982, -122.2989996], [45.6170291, -122.2989322], [45.6170966, -122.298859], [45.6172254, -122.2987386], [45.6173058, -122.2986581], [45.6173875, -122.2985336], [45.6175095, -122.2982984], [45.6175809, -122.2980968], [45.6177069, -122.2977212], [45.6178199, -122.2974292], [45.6179436, -122.2971668], [45.6179436, -122.2971668], [45.6179942, -122.2970574], [45.6181905, -122.2966488], [45.6182776, -122.2964604], [45.618343, -122.2963062], [45.6184182, -122.2961801], [45.6184868, -122.2960975], [45.6185837, -122.2960041], [45.6186128, -122.2959878], [45.6187412, -122.2959157], [45.618893, -122.295839], [45.6190433, -122.2957269], [45.6191806, -122.2955992], [45.619278, -122.2954839], [45.6195041, -122.2951383], [45.6198047, -122.2946478], [45.6200552, -122.294165], [45.6203356, -122.2936483], [45.6203356, -122.2936483], [45.620755, -122.2927513], [45.620755, -122.2927513], [45.6208681, -122.2925548], [45.6210519, -122.2922734], [45.6212425, -122.2919912], [45.6213072, -122.2918355], [45.6213585, -122.2916645], [45.6213585, -122.2916645], [45.6214283, -122.2914014], [45.6214298, -122.2913939], [45.6214786, -122.2911422], [45.6215116, -122.2908604], [45.6215431, -122.2906366], [45.6215585, -122.2905272], [45.6216504, -122.2903658], [45.6216585, -122.2903517], [45.6217454, -122.2902811], [45.6218078, -122.2902186], [45.621831, -122.2902108], [45.622151, -122.2901122], [45.6222958, -122.2900251], [45.6223929, -122.2898886], [45.6224522, -122.2896886], [45.6225709, -122.2877686], [45.6225709, -122.2877686], [45.6226121, -122.2875602], [45.6227133, -122.2872773], [45.6229408, -122.2868665], [45.6231034, -122.2865757], [45.6232287, -122.2861968], [45.6233477, -122.2855182], [45.6234106, -122.2851605], [45.6234368, -122.2849678], [45.6234709, -122.2847177], [45.6235186, -122.2845032], [45.6236085, -122.2842623], [45.6237292, -122.2839466], [45.6238962, -122.2836458], [45.6238962, -122.2836458], [45.6240844, -122.2834265], [45.6242588, -122.2832544], [45.6244525, -122.2830633], [45.6245251, -122.2830289], [45.6246374, -122.2829764], [45.624822, -122.2829344], [45.6250393, -122.2828915], [45.6255148, -122.2828534], [45.6256066, -122.2828423], [45.6256066, -122.2828423], [45.6256068, -122.2831643], [45.6256569, -122.2839794], [45.625716, -122.2854579], [45.625716, -122.2854579], [45.6257843, -122.2852751], [45.6258605, -122.2849309], [45.6258853, -122.2847225], [45.6259226, -122.2844217], [45.6259324, -122.2842473], [45.6259662, -122.2840199], [45.6259992, -122.2835994], [45.626005, -122.2835354], [45.6260369, -122.2831821], [45.6260947, -122.2827196], [45.6261437, -122.2825047], [45.6262275, -122.2822774], [45.6263471, -122.282087], [45.6270661, -122.2812745], [45.6272861, -122.2810191], [45.6275435, -122.2807496], [45.6277271, -122.280566], [45.6278404, -122.2804918], [45.6283527, -122.280326], [45.629133, -122.2800734], [45.629133, -122.2800734], [45.6294712, -122.2799237], [45.6296538, -122.2797731], [45.629754, -122.2796906], [45.629923, -122.2794848], [45.6300981, -122.2792686], [45.630257, -122.2791113], [45.6304269, -122.2790116], [45.6306926, -122.2789213], [45.6309887, -122.2788338], [45.6309887, -122.2788338], [45.6312905, -122.2787411], [45.6316357, -122.2786364], [45.6317239, -122.2786095], [45.6322214, -122.2784848], [45.6327341, -122.2783897], [45.6329491, -122.2783668], [45.6332397, -122.2783236], [45.6335953, -122.2782796], [45.6338612, -122.2782412], [45.6339785, -122.2782082], [45.6341344, -122.2781291], [45.6343835, -122.2779267], [45.6345827, -122.2776434], [45.6348433, -122.2772232], [45.6349992, -122.2769606], [45.6349992, -122.2769606], [45.6350694, -122.2768347], [45.6351244, -122.2766722], [45.6351538, -122.2765193], [45.6351402, -122.2763433], [45.6350967, -122.2762332], [45.6349919, -122.2759918], [45.6349292, -122.2757874], [45.6349088, -122.2756083], [45.6349197, -122.2754355], [45.6349197, -122.2754355], [45.6352707, -122.2737951], [45.6355414, -122.272596], [45.6356312, -122.2722462], [45.6359061, -122.2714383], [45.6359763, -122.2712359], [45.6360327, -122.2709692], [45.6361911, -122.2700217], [45.6362291, -122.2697497], [45.6362341, -122.2697137], [45.6363294, -122.2690441], [45.636446, -122.2678137], [45.6364873, -122.2675764], [45.6365485, -122.2674168], [45.6366465, -122.2672883], [45.6368098, -122.2672046], [45.6369473, -122.2672163], [45.6370482, -122.2672664], [45.6374356, -122.2676287], [45.6379611, -122.2681201], [45.6381279, -122.268362], [45.6381758, -122.2684342], [45.6382716, -122.2686295], [45.6383546, -122.2689195], [45.6384523, -122.2693908], [45.6385048, -122.269702], [45.6385575, -122.2698577], [45.6386613, -122.2700329], [45.6387737, -122.2701415], [45.6388954, -122.2701954], [45.6389823, -122.2702131], [45.6391385, -122.2702231], [45.6392485, -122.2702235], [45.6392485, -122.2702235], [45.63941, -122.2702208], [45.6403851, -122.2702045], [45.6406252, -122.2702005], [45.6413411, -122.2701885], [45.6417146, -122.2701822], [45.64184, -122.2701817], [45.6427146, -122.2701783], [45.6430429, -122.270177], [45.6431789, -122.2701648], [45.6432874, -122.2701131], [45.6433295, -122.2700739], [45.6433544, -122.2700268], [45.6433996, -122.2699152], [45.6434129, -122.2697441], [45.6433668, -122.2679015], [45.6433616, -122.2676954], [45.6433496, -122.2661576], [45.6433492, -122.2654793], [45.643365, -122.265199], [45.643392, -122.264938], [45.643433, -122.2647269], [45.6435022, -122.2644762], [45.6435022, -122.2644762], [45.6435626, -122.2642635], [45.6437193, -122.2637793], [45.6439115, -122.2632294], [45.6439568, -122.2631217], [45.6444534, -122.2619419], [45.6445634, -122.2614738], [45.6446202, -122.2610383], [45.6446804, -122.2605772], [45.6446971, -122.2604426], [45.6448463, -122.2592407], [45.6449367, -122.2585119], [45.644963, -122.2583846], [45.64499, -122.2582535], [45.6450427, -122.2580832], [45.6451069, -122.2579708], [45.645271, -122.2577256], [45.6453495, -122.2576332], [45.6456757, -122.2572791], [45.6457123, -122.2572394], [45.6458214, -122.2571211], [45.6463553, -122.2565535], [45.6465115, -122.2563796], [45.6466429, -122.2561507], [45.6467139, -122.2559645], [45.6467625, -122.2557097], [45.6468321, -122.2548667], [45.6468321, -122.2548667], [45.6469291, -122.2533065], [45.6469658, -122.2529504], [45.647018, -122.2528012], [45.647086, -122.252682], [45.6472003, -122.2525731], [45.647348, -122.25248], [45.6476286, -122.2523385], [45.6478811, -122.2522112], [45.6479705, -122.2521661], [45.6486713, -122.2518688], [45.6487427, -122.2518422], [45.6488356, -122.25182], [45.6489045, -122.2518137], [45.6496602, -122.2517625], [45.6503253, -122.2517409], [45.6503253, -122.2517409], [45.6503394, -122.2526439], [45.6503629, -122.2541438], [45.6503773, -122.2542961], [45.6504234, -122.2543883], [45.6504234, -122.2543883], [45.65048, -122.2544581], [45.6506161, -122.2545165], [45.6507543, -122.2545313], [45.6518902, -122.2545077], [45.6522934, -122.2544993], [45.6522934, -122.2544993], [45.6522412, -122.2533558], [45.652189, -122.2521009]];
      
      const map = L.map('map').setView([46.7298, -117.1817], 14);

      const tiles = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }
      ).addTo(map);
  
      let clickCount = 0;
      let markers = [];
      let polyline;

      var line = L.polyline(coordinates, { color: 'blue' }).addTo(map)

      map.on('click', (e) => {
        clickCount++;

        // Clear existing markers and polyline on the third click
        if (clickCount === 3) {
          clearMarkers();
          clickCount = 1; // Reset click count for the new set of markers
        }

        // Drop markers on the first and second clicks
        const marker = L.marker(e.latlng).addTo(map);
        markers.push(marker);

      });

      // UI button click event
      const btnCreateLine = document.getElementById('btnCreateLine');
      btnCreateLine.addEventListener('click', () => {
        // Check if there are two markers to create a line
        if (markers.length === 2) {
          const latitude1 = markers[0].getLatLng().lat;
          const longitude1 = markers[0].getLatLng().lng;
          const latitude2 = markers[1].getLatLng().lat;
          const longitude2 = markers[1].getLatLng().lng;

          // Create a list of markers
          const markersList = [
              { lat: latitude1, lon: longitude1 },
              { lat: latitude2, lon: longitude2 }
          ];

          // Create a message payload with the list of markers
          const message = {
              markers: markersList,
          };

          sendKafkaRequest(markers.map(marker => marker.getLatLng()))

          if (polyline) {
            map.removeLayer(polyline);
          }
          polyline = L.polyline([markers[0].getLatLng(), markers[1].getLatLng()], { color: 'red' }).addTo(map);
        } else {
          alert('Please create two markers first.');
        }
      });

      function clearMarkers() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        if (polyline) {
          map.removeLayer(polyline);
          polyline = null;
        }
      }
      const sendKafkaRequest = (markersList) => {

          // Create a message payload with the list of markers
          const message = {
              markers: markersList,
          };

          // Make an HTTP POST request to your Node.js server (app.js)
          fetch('http://localhost:3000/send-kafka', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(message),
          })
          .then(response => {
              if (response.ok) {
                  console.log('HTTP Request to Node.js server successful.');
              } else {
                  console.error('HTTP Request to Node.js server failed.');
              }
          })
          .catch(error => {
              console.error('Error sending HTTP Request:', error);
          });
      };

    </script>
  </body>
</html>